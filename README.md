# Shutter Controller (ESP8266 + 28BYJ-48)

Проект автоматического подъема/опускания штор на базе `Wemos D1 mini (ESP8266 / ESP-WROOM-02)`.

Основа UI взята по стилю из проекта pump/peristaltic, но логика переписана под шторы:
- один шаговый двигатель `28BYJ-48` (через `ULN2003`),
- без герконовых концевиков,
- ручная калибровка верх/низ,
- сохранение текущей позиции и параметров в `LittleFS`.

## Важно по питанию

`28BYJ-48` (обычно 5V) и `ESP8266` не стоит питать напрямую от одной 18650 без преобразователей.

Рекомендуемый вариант:
- 18650 -> DC-DC 5V для `ULN2003 + 28BYJ-48`,
- 18650 -> DC-DC 3.3V (или стабильные 5V на `5V` пин D1 mini с корректным модулем питания) для ESP8266,
- общая земля (`GND`) у ESP8266 и ULN2003 обязательна.

## Подключение

По умолчанию в прошивке:
- `D1 (GPIO5)` -> `IN1` ULN2003
- `D2 (GPIO4)` -> `IN2` ULN2003
- `D5 (GPIO14)` -> `IN3` ULN2003
- `D6 (GPIO12)` -> `IN4` ULN2003

Если мотор вращается в неверную сторону, используйте флаг `Реверс направления` в веб-интерфейсе.

## Сборка и прошивка

```bash
cd /Users/user/Documents/shutter
pio run
pio run -t upload
pio run -t uploadfs
./scripts/hw_smoke_test.sh 192.168.88.74
```

При старте контроллер сначала пробует подключиться к сети `nh` с паролем `Fx110011`.
Если не получилось, поднимается Wi-Fi портал `Shutter-Setup` (пароль `shutter123`) для настройки Wi-Fi.

## Калибровка без концевиков

Вкладка `Калибровка`:
1. Кнопками `Поднять/Опустить` доведите штору до верхней точки.
2. Нажмите `Установить верх (0%)`.
3. Доведите штору до нижней точки.
4. Нажмите `Установить низ (100%)`.

После этого контроллер хранит:
- полный ход в шагах (`travelSteps`),
- текущую позицию (`currentPosition`).

Позиция периодически сохраняется и дополнительно записывается при остановке.

## HTTP API

- `GET /api/state` — текущее состояние
- `POST /api/move` — управление движением
  - `{"action":"open"}`
  - `{"action":"close"}`
  - `{"action":"stop"}`
  - `{"action":"set","percent":50}`
  - `{"action":"jog","steps":200}`
- `POST /api/calibrate`
  - `{"action":"set_top"}`
  - `{"action":"set_bottom"}`
  - `{"action":"reset"}`
- `POST /api/settings` — изменение параметров
- `POST /api/wifi/reset` — сброс Wi-Fi и перезагрузка
- `POST /api/system/reboot` — перезагрузка без сброса Wi-Fi
- `GET/POST /api/firmware/config` — OTA repo и имена ассетов
- `POST /api/firmware/check/latest` — проверка доступности latest URL (firmware/fs)
- `POST /api/firmware/update/latest` — обновление до последнего релиза
- `POST /api/firmware/update/url` — обновление по прямым URL

## OTA (как в peristaltic)

Вкладка `Настройки -> OTA Обновление`:
1. Укажите `GitHub Repo` и имена ассетов (`firmware.bin`, `littlefs.bin`).
2. Используйте `Обновить до последнего` (формат URL: `.../releases/latest/download/...`).

Для локального OTA (без GitHub) используйте `Обновить по URL`, указав прямые ссылки на:
- `firmware.bin`
- `littlefs.bin`

## Экономия энергии Wi-Fi

В `Настройки` добавлен флаг `Wi-Fi modem sleep (экономия батареи)`.
- Выключено: `WIFI_NONE_SLEEP` (макс. отзывчивость).
- Включено: `WIFI_MODEM_SLEEP` (меньше расход, чуть выше задержка сети).

## Ограничения

Без физических концевиков и энкодера возможно накопление ошибки шага со временем (проскальзывание, пропуски шагов). Периодически повторяйте калибровку, особенно после механических изменений.
